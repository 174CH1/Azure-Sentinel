id: 04f48e13-777a-4ec7-9d00-dd709746cdb7
name: Malware detections by detection methods
description: |
  This query helps reviewing malware detections by detection methods
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
  - EmailEvents
tactics:
- Initial access
query: |
  EmailEvents
  | where Timestamp > ago(30d)
  | where isnotempty(DetectionMethods)
  | extend MDO_detection = parse_json(DetectionMethods)
  | where MDO_detection.Malware in
          (
            @'["File detonation reputation"]',
            @'["File detonation"]',
            @'["File reputation"]',
            @'["Antimalware engine"]',
            @'["URL malicious reputation"]',
            @'["URL detonation reputation"]',
            @'["URL detonation"]'
          )
  | extend SenderFromAddress_IPv4 = strcat(SenderFromAddress, ", ", SenderIPv4)
  | project Timestamp, NetworkMessageId, Subject, SenderFromAddress_IPv4, RecipientEmailAddress, DeliveryLocation, MDO_detection.Malware
