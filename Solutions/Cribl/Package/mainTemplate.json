{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Cribl - support@cribl.io",
    "comments": "Solution template for Cribl"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@mcribl.io",
    "_email": "[variables('email')]",
    "_solutionName": "Cribl",
    "_solutionVersion": "1.0.0",
    "solutionId": "cribl-stream-solution-sentinel",
    "_solutionId": "[variables('solutionId')]",
    "uiConfigId1": "Cribl",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "Cribl",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1'))))]",
    "dataConnectorVersion1": "1.0.0",
    "_dataConnectorcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId1'),'-', variables('dataConnectorVersion1'))))]",
    "parserName1": "CriblAccess",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1'))))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "CriblAccess-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "_parsercontentProductId1": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('_parserContentId1'),'-', variables('parserVersion1'))))]",
    "parserName2": "CriblInternal",
    "_parserName2": "[concat(parameters('workspace'),'/',variables('parserName2'))]",
    "parserId2": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
    "_parserId2": "[variables('parserId2')]",
    "parserTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId2'))))]",
    "parserVersion2": "1.0.0",
    "parserContentId2": "CriblInternal-Parser",
    "_parserContentId2": "[variables('parserContentId2')]",
    "_parsercontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('_parserContentId2'),'-', variables('parserVersion2'))))]",
    "parserName3": "CriblAudit",
    "_parserName3": "[concat(parameters('workspace'),'/',variables('parserName3'))]",
    "parserId3": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName3'))]",
    "_parserId3": "[variables('parserId3')]",
    "parserTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId3'))))]",
    "parserVersion3": "1.0.0",
    "parserContentId3": "CriblAudit-Parser",
    "_parserContentId3": "[variables('parserContentId3')]",
    "_parsercontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('_parserContentId3'),'-', variables('parserVersion3'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Cribl data connector with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Cribl",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "The [Cribl](https://cribl.io/accelerate-cloud-migration/) connector allows you to easily connect your Cribl (Cribl Enterprise Edition - Standalone) logs with Microsoft Sentinel. This gives you more security insight into your organization's data pipelines.",
                  "additionalRequirementBanner": "This data connector depends on three parsers based on a Kusto Function to work as expected [**Cribl Access Logs**](https://aka.ms/sentinel-CriblAccess-parser), [**Cribl Audit Logs**](https://aka.ms/sentinel-CriblAudit-parser) and [**Cribl Application Logs**](https://aka.ms/sentinel-CriblInternal-parser) which are deployed with the Microsoft Sentinel Solution.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "CriblInternal",
                      "baseQuery": "CriblInternal"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "CriblAudit",
                      "baseQuery": "CriblAudit"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "CriblAccess",
                      "baseQuery": "CriblAccess"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Cribl Application Logs",
                      "query": "CriblInternal | sort by TimeGenerated"
                    },
                    {
                      "description": "Cribl Audit Logs",
                      "query": "CriblAudit | sort by TimeGenerated"
                    },
                    {
                      "description": "Cribl Access Logs",
                      "query": "CriblAccess | sort by TimeGenerated"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "Syslog (CriblAccess)",
                      "lastDataReceivedQuery": "CriblAccess\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Syslog (CriblAudit)",
                      "lastDataReceivedQuery": "CriblAudit\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Syslog (CriblInternal)",
                      "lastDataReceivedQuery": "CriblInternal\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "CriblInternal\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "CriblAudit\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "CriblAccess\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "write permission is required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "delete": true
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                      {
                        "step": "Create Credentials for a New Azure Application",
                        "actions": [
                          "Log into the Azure portal as an Administrator",
                          "Navigate to the portal's App registration section",
                          "Click New registration to register an application",
                          "Register a new application with the name 'Cribl Stream'",
                          "Click Register",
                          "Store the Application (client) ID and Directory (tenant) ID",
                          "In the newly registered application, select the Certificates & secrets tab",
                          "Create a New client secret",
                          "Store the secret Value"
                        ]
                      },
                      {
                        "step": "Create a Data Collection Endpoint",
                        "actions": [
                          "Navigate to the Azure portal's Monitor service",
                          "Under Settings, select Data Collection Endpoints",
                          "Select Create to add a new endpoint named 'Cribl-Stream-Ingestion'",
                          "Select the appropriate Subscription and Resource Group",
                          "Select Review + create, review changes, then select Create",
                          "Open the newly created endpoint in the list of Data Collection Endpoints",
                          "Navigate to the Overview page, copy and store the Logs Ingestion URL",
                          "Select JSON view, store the value of the Resource ID"
                        ]
                      },
                      {
                        "step": "Find the Log Analytics Workspace Resource ID",
                        "actions": [
                          "Navigate to the Azure portal's Log Analytics workspaces service",
                          "Select the workspace that will receive data",
                          "From the Overview page, select JSON view, store the value of the Resource ID"
                        ]
                      },
                      {
                        "step": "Create Data Collection Rule",
                        "actions": [
                          "Navigate to the Azure portal's Deploy a custom template service",
                          "Select Build your own template in the editor",
                          "Select Load file and upload the DCR Template",
                          "Click Save",
                          "Select the appropriate Subscription and Resource Group",
                          "Name the new Data Collection Rule 'Cribl-Stream-Ingestion-Rule'",
                          "Enter the Log Analytics Workspace Resource ID and Data Collection Endpoint Resource ID",
                          "Click Review + create, followed by Create"
                        ]
                      },
                      {
                        "step": "Add Role Assignment",
                        "actions": [
                          "Once the template has been deployed, click Go to resource",
                          "From the Overview page, select JSON view, store the immutableId from the JSON body",
                          "Click the Data Collection Rule's Access control (IAM)",
                          "Click Add role assignment",
                          "Select the Monitoring Metrics Publisher role, then click Next",
                          "Click + Select members",
                          "Search for and select 'Cribl Stream', then click Select to confirm",
                          "Click Review + assign to review changes",
                          "Click Review + assign again to implement the permissions update"
                        ]
                      }
                    ],
                  "metadata": {
                    "id": "Unique Identifier (GUID) used to identify dependencies and content from solutions or community.",
                    "version": "1.0.0",
                    "kind": "dataConnector",
                    "source": {
                      "kind": "community"
                    },
                    "author": {
                      "name": "Guillaume Benats"
                    },
                    "support": {
                      "tier": "community",
                      "name": "Guillaume Benats",
                      "link": "https://github.com/Azure/Azure-Sentinel/issues"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Cribl",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Cribl",
                  "email": "support@mcribl.io",
                  "tier": "Partner",
                  "link": "https://cribl.io/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "1.0.0",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "contentKind": "DataConnector",
        "displayName": "Cribl",
        "contentProductId": "[variables('_dataConnectorcontentProductId1')]",
        "id": "[variables('_dataConnectorcontentProductId1')]",
        "version": "[variables('dataConnectorVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Partner",
          "link": "https://cribl.io/support"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cribl",
          "publisher": "Microsoft",
          "descriptionMarkdown": "The [Cribl](https://cribl.io/accelerate-cloud-migration/) connector allows you to easily connect your Cribl (Cribl Enterprise Edition - Standalone) logs with Microsoft Sentinel. This gives you more security insight into your organization's data pipelines.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CriblInternal",
              "baseQuery": "CriblInternal"
            },
            {
              "metricName": "Total data received",
              "legend": "CriblAudit",
              "baseQuery": "CriblAudit"
            },
            {
              "metricName": "Total data received",
              "legend": "CriblAccess",
              "baseQuery": "CriblAccess"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog (CriblAccess)",
              "lastDataReceivedQuery": "CriblAccess\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Syslog (CriblAudit)",
              "lastDataReceivedQuery": "CriblAudit\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Syslog (CriblInternal)",
              "lastDataReceivedQuery": "CriblInternal\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CriblInternal\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "CriblAudit\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "CriblAccess\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Cribl Application Logs",
              "query": "CriblInternal | sort by TimeGenerated"
            },
            {
              "description": "Cribl Audit Logs",
              "query": "CriblAudit | sort by TimeGenerated"
            },
            {
              "description": "Cribl Access Logs",
              "query": "CriblAccess | sort by TimeGenerated"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
                      {
                        "step": "Create Credentials for a New Azure Application",
                        "actions": [
                          "Log into the Azure portal as an Administrator",
                          "Navigate to the portal's App registration section",
                          "Click New registration to register an application",
                          "Register a new application with the name 'Cribl Stream'",
                          "Click Register",
                          "Store the Application (client) ID and Directory (tenant) ID",
                          "In the newly registered application, select the Certificates & secrets tab",
                          "Create a New client secret",
                          "Store the secret Value"
                        ]
                      },
                      {
                        "step": "Create a Data Collection Endpoint",
                        "actions": [
                          "Navigate to the Azure portal's Monitor service",
                          "Under Settings, select Data Collection Endpoints",
                          "Select Create to add a new endpoint named 'Cribl-Stream-Ingestion'",
                          "Select the appropriate Subscription and Resource Group",
                          "Select Review + create, review changes, then select Create",
                          "Open the newly created endpoint in the list of Data Collection Endpoints",
                          "Navigate to the Overview page, copy and store the Logs Ingestion URL",
                          "Select JSON view, store the value of the Resource ID"
                        ]
                      },
                      {
                        "step": "Find the Log Analytics Workspace Resource ID",
                        "actions": [
                          "Navigate to the Azure portal's Log Analytics workspaces service",
                          "Select the workspace that will receive data",
                          "From the Overview page, select JSON view, store the value of the Resource ID"
                        ]
                      },
                      {
                        "step": "Create Data Collection Rule",
                        "actions": [
                          "Navigate to the Azure portal's Deploy a custom template service",
                          "Select Build your own template in the editor",
                          "Select Load file and upload the DCR Template",
                          "Click Save",
                          "Select the appropriate Subscription and Resource Group",
                          "Name the new Data Collection Rule 'Cribl-Stream-Ingestion-Rule'",
                          "Enter the Log Analytics Workspace Resource ID and Data Collection Endpoint Resource ID",
                          "Click Review + create, followed by Create"
                        ]
                      },
                      {
                        "step": "Add Role Assignment",
                        "actions": [
                          "Once the template has been deployed, click Go to resource",
                          "From the Overview page, select JSON view, store the immutableId from the JSON body",
                          "Click the Data Collection Rule's Access control (IAM)",
                          "Click Add role assignment",
                          "Select the Monitoring Metrics Publisher role, then click Next",
                          "Click + Select members",
                          "Search for and select 'Cribl Stream', then click Select to confirm",
                          "Click Review + assign to review changes",
                          "Click Review + assign again to implement the permissions update"
                        ]
                      }
                    ],        
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": "This data connector depends on three parsers based on a Kusto Function to work as expected [**Cribl Access Logs**](https://aka.ms/sentinel-CriblAccess-parser), [**Cribl Audit Logs**](https://aka.ms/sentinel-CriblAudit-parser) and [**Cribl Application Logs**](https://aka.ms/sentinel-CriblInternal-parser) which are deployed with the Microsoft Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CriblAccess Data Parser with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for CriblAccess",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "CriblAccess",
                "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Access-Logs'\n| where SyslogMessage has_any (\"GET\",\"POST\",\"PUT\",\"DELETE\",\"PATCH\") and SyslogMessage contains \"HTTP\"\n| parse SyslogMessage with IPAddress \" - - [\" EventTime \"] \\\"\" RequestVerb \" \" URI \" \" HTTPVersion \"\\\"\" ResponseCode \" \" BytesSent \"\\\"\" HTTPReferer \"\\\" \\\"\" UserAgent\n| project TimeGenerated, EventTime = todatetime(EventTime), IPAddress, RequestVerb, URI, HTTPVersion, ResponseCode, BytesSent, HTTPReferer, UserAgent\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserId1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Cribl",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Cribl",
                  "email": "support@cribl.io",
                  "tier": "Partner",
                  "link": "https://cribl.io/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "1.0.0",
        "contentId": "[variables('_parserContentId1')]",
        "contentKind": "Parser",
        "displayName": "Parser for CriblAccess",
        "contentProductId": "[variables('_parsercontentProductId1')]",
        "id": "[variables('_parsercontentProductId1')]",
        "version": "[variables('parserVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for CriblAccess",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "CriblAccess",
        "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Access-Logs'\n| where SyslogMessage has_any (\"GET\",\"POST\",\"PUT\",\"DELETE\",\"PATCH\") and SyslogMessage contains \"HTTP\"\n| parse SyslogMessage with IPAddress \" - - [\" EventTime \"] \\\"\" RequestVerb \" \" URI \" \" HTTPVersion \"\\\"\" ResponseCode \" \" BytesSent \"\\\"\" HTTPReferer \"\\\" \\\"\" UserAgent\n| project TimeGenerated, EventTime = todatetime(EventTime), IPAddress, RequestVerb, URI, HTTPVersion, ResponseCode, BytesSent, HTTPReferer, UserAgent\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Partner",
          "link": "https://cribl.io/support"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CriblInternal Data Parser with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName2')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for CriblInternal",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "CriblInternal",
                "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Application-Logs'\n| extend parsedMessage = parse_json(SyslogMessage)\n| project TimeGenerated, \n  Severity = parsedMessage.severity,\n  Computer,\n  HostName,\n  HostIP,\n  EventTime = todatetime(parsedMessage.['time']),\n  CorrelationID = parsedMessage.correlation_id,\n  Message = parsedMessage.message,\n  FailedLogin = iff(parsedMessage hasprefix_cs \"Failed Login\",1,0),\n  UserAdded = iff(parsedMessage hassuffix_cs \"was created\",1,0),\n  UserImpersonated = iff(parsedMessage matches regex \".*impersonating.*\",1,0)\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
              "dependsOn": [
                "[variables('_parserId2')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
                "contentId": "[variables('_parserContentId2')]",
                "kind": "Parser",
                "version": "[variables('parserVersion2')]",
                "source": {
                  "name": "Cribl",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Cribl",
                  "email": "support@cribl.io",
                  "tier": "Partner",
                  "link": "https://cribl.io/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "1.0.0",
        "contentId": "[variables('_parserContentId2')]",
        "contentKind": "Parser",
        "displayName": "Parser for CriblInternal",
        "contentProductId": "[variables('_parsercontentProductId2')]",
        "id": "[variables('_parsercontentProductId2')]",
        "version": "[variables('parserVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('_parserName2')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for CriblInternal",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "CriblInternal",
        "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Application-Logs'\n| extend parsedMessage = parse_json(SyslogMessage)\n| project TimeGenerated, \n  Severity = parsedMessage.severity,\n  Computer,\n  HostName,\n  HostIP,\n  EventTime = todatetime(parsedMessage.['time']),\n  CorrelationID = parsedMessage.correlation_id,\n  Message = parsedMessage.message,\n  FailedLogin = iff(parsedMessage hasprefix_cs \"Failed Login\",1,0),\n  UserAdded = iff(parsedMessage hassuffix_cs \"was created\",1,0),\n  UserImpersonated = iff(parsedMessage matches regex \".*impersonating.*\",1,0)\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId2'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId2')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName2'))]",
        "contentId": "[variables('_parserContentId2')]",
        "kind": "Parser",
        "version": "[variables('parserVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Partner",
          "link": "https://cribl.io/support"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "CriblAudit Data Parser with template version 1.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName3')]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for CriblAudit",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "CriblAudit",
                "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Audit-Logs'\n| extend parsedMessage = parse_json(SyslogMessage)\n| project TimeGenerated, \n  Severity = parsedMessage.severity,\n  EventTime = todatetime(parsedMessage.['time']),\n  CorrelationID = parsedMessage.correlation_id,\n  AuthorID = tostring(parsedMessage.author_id),\n  AuthorName = tostring(parsedMessage.author_name),\n  EntityID = parsedMessage.entity_id,\n  EntityType = parsedMessage.entity_type,\n  IPAddress = parsedMessage.ip_address,\n  AddAction = parsedMessage.['add'],\n  DelAction = parsedMessage.['del'],\n  RemoveAction = parsedMessage.['remove'],\n  TargetID = tostring(parsedMessage.target_id),\n  TargetType = tostring(parsedMessage.target_type),\n  TargetDetails = tostring(parsedMessage.target_details),\n  EntityName = tostring(parsedMessage.entity_path),\n  Action = tostring(parsedMessage.action),\n  CustomMessage = tostring(parsedMessage.custom_message),\n  AuthenticationType = tostring(parsedMessage.['with']),\n  SourceVisibility = tostring(parsedMessage.From),\n  TargetVisibility = tostring(parsedMessage.To),\n  ChangeType = tostring(parsedMessage.change)\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId3'),'/'))))]",
              "dependsOn": [
                "[variables('_parserId3')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName3'))]",
                "contentId": "[variables('_parserContentId3')]",
                "kind": "Parser",
                "version": "[variables('parserVersion3')]",
                "source": {
                  "name": "Cribl",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Cribl",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Cribl",
                  "email": "support@cribl.io",
                  "tier": "Partner",
                  "link": "https://cribl.io/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "1.0.0",
        "contentId": "[variables('_parserContentId3')]",
        "contentKind": "Parser",
        "displayName": "Parser for CriblAudit",
        "contentProductId": "[variables('_parsercontentProductId3')]",
        "id": "[variables('_parsercontentProductId3')]",
        "version": "[variables('parserVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('_parserName3')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for CriblAudit",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "CriblAudit",
        "query": "Syslog\n| where Facility == 'local7'\n| where ProcessName == 'Cribl-Audit-Logs'\n| extend parsedMessage = parse_json(SyslogMessage)\n| project TimeGenerated, \n  Severity = parsedMessage.severity,\n  EventTime = todatetime(parsedMessage.['time']),\n  CorrelationID = parsedMessage.correlation_id,\n  AuthorID = tostring(parsedMessage.author_id),\n  AuthorName = tostring(parsedMessage.author_name),\n  EntityID = parsedMessage.entity_id,\n  EntityType = parsedMessage.entity_type,\n  IPAddress = parsedMessage.ip_address,\n  AddAction = parsedMessage.['add'],\n  DelAction = parsedMessage.['del'],\n  RemoveAction = parsedMessage.['remove'],\n  TargetID = tostring(parsedMessage.target_id),\n  TargetType = tostring(parsedMessage.target_type),\n  TargetDetails = tostring(parsedMessage.target_details),\n  EntityName = tostring(parsedMessage.entity_path),\n  Action = tostring(parsedMessage.action),\n  CustomMessage = tostring(parsedMessage.custom_message),\n  AuthenticationType = tostring(parsedMessage.['with']),\n  SourceVisibility = tostring(parsedMessage.From),\n  TargetVisibility = tostring(parsedMessage.To),\n  ChangeType = tostring(parsedMessage.change)\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId3'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId3')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName3'))]",
        "contentId": "[variables('_parserContentId3')]",
        "kind": "Parser",
        "version": "[variables('parserVersion3')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Partner",
          "link": "https://cribl.io/support"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "1.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "1.0.0",
        "displayName": "Cribl",
        "publisherDisplayName": "Cribl",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>The <a href=\"https://docs.cribl.io/stream/usecase-azure-sentinel/\">Cribl</a> solution allows you to easily connect your Cribl (Cribl Enterprise Edition - Standalone) logs into Microsoft Sentinel. This gives you more security insight into your organization's data pipelines.  .</p>\n<p><strong>Underlying Microsoft Technologies used:</strong></p>\n<p>This solution takes a dependency on the following technologies, and some of these dependencies either may be in <a href=\"https://azure.microsoft.com/support/legal/preview-supplemental-terms/\">Preview</a> state or might result in additional ingestion or operational costs:</p>\n<ol type=\"a\">\n<li><a href=\"https://docs.microsoft.com/azure/sentinel/connect-syslog\">Agent-based log collection (Syslog)</a></li>\n</ol>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 3, <strong>Analytic Rules:</strong> 9</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Azure_Sentinel.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Cribl",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Cribl",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Cribl",
          "email": "support@cribl.io",
          "tier": "Partner",
          "link": "https://cribl.io/support"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId2')]",
              "version": "[variables('parserVersion2')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId3')]",
              "version": "[variables('parserVersion3')]"
            }
          ]
        },
        "firstPublishDate": "2024-08-02",
        "lastPublishDate": "2024-08-02",
        "providers": [
          "Cribl"
        ],
        "categories": {
          "domains": [
            "Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}