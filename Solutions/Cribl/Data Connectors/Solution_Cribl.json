{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "resources": [
      {
        "type": "Microsoft.Insights/dataCollectionEndpoints",
        "apiVersion": "2021-05-01-preview",
        "location": "[resourceGroup().location]",
        "name": "Cribl-Stream-Ingestion",
        "properties": {
          "logsIngestion": {
            "endpoint": "[concat('https://', resourceGroup().location, '.ods.opinsights.azure.com/api/logs?api-version=2016-04-01')]"
          }
        }
      },
      {
        "type": "Microsoft.Insights/dataCollectionRules",
        "apiVersion": "2021-05-01-preview",
        "location": "[resourceGroup().location]",
        "name": "Cribl-Stream-Ingestion-Rule",
        "dependsOn": [
          "[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'Cribl-Stream-Ingestion')]"
        ],
        "properties": {
          "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'Cribl-Stream-Ingestion')]",
          "dataFlows": [
            {
              "streams": [
                {
                  "streamName": "CommonSecurityLog",
                  "tableName": "CommonSecurityLog"
                }
              ]
            }
          ],
          "destinations": [
            {
              "workspaceResourceId": "[parameters('workspaceResourceId')]"
            }
          ]
        }
      },
      {
        "type": "Microsoft.Authorization/roleAssignments",
        "apiVersion": "2020-04-01-preview",
        "name": "[guid(resourceGroup().id, 'Cribl-Stream-Ingestion-Rule', 'Monitoring Metrics Publisher')]",
        "dependsOn": [
          "[resourceId('Microsoft.Insights/dataCollectionRules', 'Cribl-Stream-Ingestion-Rule')]"
        ],
        "properties": {
          "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]",
          "principalId": "[parameters('clientId')]",
          "principalType": "ServicePrincipal",
          "scope": "[resourceId('Microsoft.Insights/dataCollectionRules', 'Cribl-Stream-Ingestion-Rule')]"
        }
      }
    ],
    "parameters": {
      "workspaceResourceId": {
        "type": "string",
        "metadata": {
          "description": "Resource ID of the Log Analytics Workspace"
        }
      },
      "clientId": {
        "type": "string",
        "metadata": {
          "description": "Client ID of the registered application"
        }
      }
    }
  }