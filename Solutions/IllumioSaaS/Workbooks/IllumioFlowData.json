{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Filters for querying traffic data",
        "expandable": true,
        "expanded": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### Please enter source ip, destination ip, destination port, protocol, time range to filter traffic records. \n### These parameters will default to */all unless provided. In case of time range, it defaults to last 24hours.\n",
              "style": "info"
            },
            "name": "text - 9"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "8ab7ce90-16a6-4e7e-85b7-292234a9d3c1",
                  "version": "KqlParameterItem/1.0",
                  "name": "src_ip",
                  "type": 1,
                  "description": "Enter source ip for fetching traffic records",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b",
                        "match": false,
                        "message": "IP addresses should be in the format of xxx.xxx.xxx.xxx where each xxx is a number between 0 and 255."
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "*"
                },
                {
                  "id": "24f11ee0-0b0b-4c79-918b-01df57233aa2",
                  "version": "KqlParameterItem/1.0",
                  "name": "dst_ip",
                  "type": 1,
                  "description": "Destination ip for fetching traffic records",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b",
                        "match": false,
                        "message": "IP addresses should be in the format of xxx.xxx.xxx.xxx where each xxx is a number between 0 and 255."
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "eb9fe16e-be04-479d-9389-0095c2b43d50",
                  "version": "KqlParameterItem/1.0",
                  "name": "dst_port",
                  "type": 1,
                  "description": "Destination port for fetching traffic records",
                  "typeSettings": {
                    "paramValidationRules": [
                      {
                        "regExp": "^(?:[0-9]|[1-9][0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-6])$",
                        "match": false,
                        "message": " Value between 0 and 65535"
                      }
                    ]
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "416ab303-c10f-47c1-9f01-7c1324699b49",
                  "version": "KqlParameterItem/1.0",
                  "name": "protocol",
                  "type": 1,
                  "description": "Protocol for fetching traffic records",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "f3b8b3e2-2457-4713-b220-c1bb38b930a3",
                  "version": "KqlParameterItem/1.0",
                  "name": "time_range",
                  "type": 4,
                  "description": "Time filter for traffic records",
                  "isGlobal": true,
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 2592000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "value": {
                    "durationMs": 604800000
                  }
                }
              ],
              "style": "formHorizontal",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "30",
            "name": "all_traffic_params",
            "styleSettings": {
              "maxWidth": "30"
            }
          }
        ],
        "exportParameters": true
      },
      "name": "parameters_group"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); //iff(isempty(dst_port_input), -1, toint(dst_port_input));\nlet protocol_flag = isempty(protocol_input); //iff(isempty(protocol_input), -1, toint(protocol_input));\n\ntable('Illumio_Flow_Events_CL')\n| where (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n//| project src_ip, dst_ip, dst_port, proto\n| summarize count() by bin(TimeGenerated, 1h)",
        "size": 0,
        "aggregation": 3,
        "title": "Traffic every hour",
        "timeContextFromParameter": "time_range",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "linechart"
      },
      "name": "traffic-every-hour"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); \nlet protocol_flag = isempty(protocol_input); \n\ntable('Illumio_Flow_Events_CL')\n| where (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n| extend workload = iif(isempty(src_href), dst_href, src_href)\n| summarize Count = count() by workload\n| top 5 by Count\n",
        "size": 1,
        "title": "Top 5 Most Trafficked Workloads",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "tileSettings": {
          "showBorder": false,
          "titleContent": {
            "columnMatch": "workload",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "Count",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto"
            },
            "numberFormat": {
              "unit": 17,
              "options": {
                "maximumSignificantDigits": 3,
                "maximumFractionDigits": 2
              }
            }
          }
        }
      },
      "name": "Top 5 Most Trafficked Workloads"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "\nlet src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); \nlet protocol_flag = isempty(protocol_input); \n\ntable('Illumio_Flow_Events_CL')\n| where (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n| extend service = strcat(dst_port,'-',proto)\n| summarize service_count = count() by service\n| top 5 by service_count",
        "size": 0,
        "title": "Top 5 Trafficked Services",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart"
      },
      "name": "Top 5 Trafficked Services"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// stats sum(flows) AS Flows BY policy_decision\nlet src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); \nlet protocol_flag = isempty(protocol_input); \n\ntable('Illumio_Flow_Events_CL')\n| where (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n| extend policy_decision = case(\n    pd == 0, \"Allowed\",\n    pd == 1, \"Potentially Blocked\",\n    pd == 2, \"Blocked\",\n    \"Unknown\"\n)\n| summarize count(flow_count) by policy_decision",
        "size": 0,
        "title": "Flow count by policy decision",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "barchart"
      },
      "name": "Flow count by policy decision"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "\n\nlet src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); \nlet protocol_flag = isempty(protocol_input); \n\ntable('Illumio_Flow_Events_CL')\n| where (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n| summarize traffic_count = count() by dst_port\n| top 5 by traffic_count\n",
        "size": 0,
        "title": "Top 5 Ports by Flow Count",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "visualization": "categoricalbar"
      },
      "name": "Top 5 Ports by Flow Count"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// Blocked traffic insights\nlet src_ip_input = '{src_ip}';\nlet dst_ip_input = '{dst_ip}';\nlet dst_port_input = '{dst_port}';\nlet protocol_input = '{protocol}';\n\nlet src_ip_flag = isempty(src_ip_input);\nlet dst_ip_flag = isempty(dst_ip_input);\nlet dst_port_flag = isempty(dst_port_input); \nlet protocol_flag = isempty(protocol_input); \n\ntable('Illumio_Flow_Events_CL')\n| where pd == 2  and (src_ip_flag or src_ip == format_ipv4(src_ip_input)) and (dst_ip_flag or  dst_ip == format_ipv4(dst_ip_input)) and (dst_port_flag or dst_port == toint(dst_port_input)) and (protocol_flag or proto == toint(protocol_input)) \n| project src_ip, src_href, dst_ip, dst_href, dst_port, proto\n| limit 10",
        "size": 0,
        "title": "Blocked Traffic",
        "timeContextFromParameter": "time_range",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Blocked Traffic"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/9c26c390-3311-4d6d-8f3c-4a240151e956/resourcegroups/ashwin.venkatesha-rg/providers/microsoft.operationalinsights/workspaces/testla"
  ],
  "fromTemplateId": "sentinel-IllumioFlowData",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}