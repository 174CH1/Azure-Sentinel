{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "ExtraHop",
    "comments": "Solution template for ExtraHop Reveal(x)"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "ExtraHop",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "extrahop.extrahop_revealx_mss",
    "_solutionId": "[variables('solutionId')]",
    "_solutionName": "ExtraHop Reveal(x)",
    "_solutionVersion": "3.0.0",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "ExtraHopDetectionSummaryWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1'))))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "_workbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','wb','-', uniqueString(concat(variables('_solutionId'),'-','Workbook','-',variables('_workbookContentId1'),'-', variables('workbookVersion1'))))]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "ExtraHopDetectionSummaryWorkbook Workbook with template version 3.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into ExtraHop Reveal(x) detections by analyzing traffic and activities.\nThis workbook provides an overview of security detections in your organization's network, including high-risk detections and top participants."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## ExtraHop Detections\\n---\\n\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"2b036d8d-8429-40a5-a5f4-8f7473738749\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"query_times\",\"label\":\"Time Interval\",\"type\":4,\"description\":\"Time range for detection Start Times\",\"isRequired\":true,\"value\":{\"durationMs\":86400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"ExtraHop\\\"\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\n| extend detectionID = DeviceCustomNumber1\\n| extend StartTime = coalesce(\\n                            column_ifexists(\\\"StartTime\\\", datetime(null)),\\n                            extract(\\\"start=([0-9-]+T[0-9:.]+Z)\\\", 1, AdditionalExtensions,typeof(datetime)),\\n                            datetime(null)\\n                        )\\n| summarize arg_min(todatetime(ReceiptTime), *) by detectionID\\n| summarize count(detectionID) by Activity, bin(make_datetime(ReceiptTime), 1h)\\n\",\"size\":0,\"title\":\"Detections by Recently Updated\",\"timeContextFromParameter\":\"query_times\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\",\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Activity\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_detectionID\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"detections_by_time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let category_map = dynamic(\\n{\\n    \\\"sec.action\\\" : \\\"Actions on Objective\\\",\\n    \\\"sec.caution\\\": \\\"Caution\\\",\\n    \\\"sec.command\\\": \\\"Command and Control\\\",\\n    \\\"sec.exploit\\\": \\\"Exploitation\\\",\\n    \\\"sec.lateral\\\": \\\"Lateral Movement\\\",\\n    \\\"sec.recon\\\": \\\"Reconnaissance\\\"\\n    }\\n);\\nCommonSecurityLog\\n| where DeviceVendor == \\\"ExtraHop\\\"\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\n| extend categories = iif(DeviceCustomString2 != \\\"\\\", split(DeviceCustomString2, \\\",\\\"),dynamic(null))\\n| extend detectionID = DeviceCustomNumber1\\n| project detectionID, updateTime=todatetime(ReceiptTime), categories\\n| summarize arg_max(updateTime, *) by detectionID\\n| sort by detectionID desc \\n| where isnotnull(categories)\\n| mv-expand cat=categories to typeof(string)\\n| extend cat = coalesce(column_ifexists(\\\"DeviceEventCategory\\\",\\\"\\\"),cat) \\n| summarize count() by cat\\n| project Category=tostring(category_map[cat]), Count=count_\\n| where Category != \\\"\\\"\",\"size\":0,\"title\":\"Detections by Category\",\"timeContextFromParameter\":\"query_times\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"total-detections-pie\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let ExtraHopDetections = materialize(CommonSecurityLog\\n    | where DeviceVendor == \\\"ExtraHop\\\"\\n    | extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\n    | extend detectionID = DeviceCustomNumber1\\n    | extend StartTime = coalesce(\\n                            column_ifexists(\\\"StartTime\\\", datetime(null)),\\n                            extract(\\\"start=([0-9-]+T[0-9:.]+Z)\\\", 1, AdditionalExtensions,typeof(datetime)),\\n                            datetime(null)\\n                        )\\n    | project SourceIP, DestinationIP, detectionID, StartTime\\n    | summarize arg_max(todatetime(StartTime), *) by detectionID\\n    | sort by detectionID desc);\\nlet t1 = ExtraHopDetections | where SourceIP != \\\"\\\" | summarize dcount=dcount(detectionID) by SourceIP | project IPAddress=SourceIP, dcount;\\nlet t2 = ExtraHopDetections | where DestinationIP != \\\"\\\" | summarize dcount=dcount(detectionID) by DestinationIP | project IPAddress=DestinationIP, dcount;\\nt1 | union t2 | summarize Count=sum(dcount) by [\\\"IP Address\\\"]=IPAddress | top 10 by Count desc\",\"size\":0,\"title\":\"Top Participants\",\"timeContextFromParameter\":\"query_times\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"35\",\"name\":\"top-participants\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n    | where DeviceVendor == \\\"ExtraHop\\\"\\n    | extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1)\\n    | extend StartTime = coalesce(\\n                            column_ifexists(\\\"StartTime\\\", datetime(null)),\\n                            extract(\\\"start=([0-9-]+T[0-9:.]+Z)\\\", 1, AdditionalExtensions,typeof(datetime)),\\n                            datetime(null)\\n                        )\\n    | extend detectionID = DeviceCustomNumber1\\n    | summarize arg_max(todatetime(StartTime), *) by detectionID\\n    | summarize Count=count() by Activity\\n    | sort by Count desc, Activity asc\\n    | project-rename [\\\"Detection Title\\\"]=Activity\",\"size\":0,\"title\":\"Top Detections by Title\",\"timeContextFromParameter\":\"query_times\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"35\",\"name\":\"detections-by-title\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CommonSecurityLog\\n| where DeviceVendor == \\\"ExtraHop\\\"\\n| extend DeviceCustomNumber1 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber1\\\", long(null)),DeviceCustomNumber1),\\n         DeviceCustomNumber2 = coalesce(column_ifexists(\\\"FieldDeviceCustomNumber2\\\", long(null)),DeviceCustomNumber2)\\n| summarize arg_max(ReceiptTime, *) by DeviceCustomNumber1 // detection ID\\n| sort by DeviceCustomNumber2 // risk score\\n| project [\\\"Risk Score\\\"] = DeviceCustomNumber2,\\nTitle=Activity, \\nSourceIP,\\nDestinationIP,\\n[\\\"Last Updated\\\"]=format_datetime(make_datetime(ReceiptTime), 'M/d/yyyy HH:mm:ss'),\\nID=DeviceCustomNumber1,\\nURI=DeviceCustomString1\\n| take 10\\n\",\"size\":0,\"title\":\"Top Ten Detections by Highest Risk Score\",\"timeContextFromParameter\":\"query_times\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"top-ten-by-risk\"}],\"fromTemplateId\":\"sentinel-ExtraHop\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ExtraHopDetectionSummaryWorkbook; logoFileName=extrahop_logo.svg; description=Gain insights into ExtraHop Reveal(x) detections by analyzing traffic and activities.\nThis workbook provides an overview of security detections in your organization's network, including high-risk detections and top participants.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=ExtraHop; templateRelativePath=ExtraHopDetectionSummary.json; subtitle=; provider=ExtraHop Networks}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "ExtraHop Reveal(x)",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "ExtraHop"
                },
                "support": {
                  "name": "ExtraHop",
                  "tier": "partner",
                  "link": "https://www.extrahop.com/support/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "CommonSecurityLog",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ExtraHopNetworks",
                      "kind": "DataConnector"
                    },
                    {
                      "contentId": "ExtraHopNetworksAma",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_workbookContentId1')]",
        "contentKind": "Workbook",
        "displayName": "[parameters('workbook1-name')]",
        "contentProductId": "[variables('_workbookcontentProductId1')]",
        "id": "[variables('_workbookcontentProductId1')]",
        "version": "[variables('workbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "ExtraHop Reveal(x)",
        "publisherDisplayName": "ExtraHop",
        "descriptionHtml": "<p><strong>Note:</strong> <em>There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</em></p>\n<p>The <a href=\"https://www.extrahop.com/products/security/\">ExtraHop Reveal(x)</a> Solution for Microsoft Sentinel enables ingestion of Common Event Format (CEF) logs into Microsoft Sentinel. This solution enables you to view dashboards, create custom alerts, and improve investigation. This integration gives you the ability to gain insight into your organization's network and improve your security operation capabilities.</p>\n<ol>\n<li><p><strong>ExtraHop Reveal(x) via AMA</strong> - This data connector helps in ingesting ExtraHop Reveal(x) logs into your Log Analytics Workspace using the new Azure Monitor Agent. Learn more about ingesting using the new Azure Monitor Agent <a href=\"https://learn.microsoft.com/azure/sentinel/connect-cef-ama\">here</a>. <strong>Microsoft recommends using this Data Connector</strong>.</p>\n</li>\n<li><p><strong>ExtraHop Reveal(x) via Legacy Agent</strong> - This data connector helps in ingesting ExtraHop Reveal(x) logs into your Log Analytics Workspace using the legacy Log Analytics agent.</p>\n</li>\n</ol>\n<p><strong>NOTE:</strong> Microsoft recommends installation of ExtraHop Reveal(x) via AMA Connector. Legacy connector uses the Log Analytics agent which is about to be deprecated by <strong>Aug 31, 2024,</strong> and thus should only be installed where AMA is not supported. Using MMA and AMA on same machine can cause log duplication and extra ingestion cost <a href=\"https://learn.microsoft.com/en-us/azure/sentinel/ama-migrate\">more details</a>.</p>\n<p><strong>Workbooks:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/ExtraHopLogo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "ExtraHop Reveal(x)",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "ExtraHop"
        },
        "support": {
          "name": "ExtraHop",
          "tier": "partner",
          "link": "https://www.extrahop.com/support/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2022-05-19",
        "providers": [
          "ExtraHop"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Security - Cloud Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
